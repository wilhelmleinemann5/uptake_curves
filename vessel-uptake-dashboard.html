<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vessel Uptake Dashboard - PENNY â†” DELTA</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <link rel="stylesheet" href="styles/maersk-theme.css">
    <style>
        .uptake-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--mds-bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .uptake-table th {
            background: var(--mds-bg-strong);
            color: var(--mds-text-primary);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            border-bottom: 2px solid var(--mds-border-default);
        }
        
        .uptake-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--mds-border-default);
            color: var(--mds-text-primary);
            font-size: 0.9rem;
        }
        
        .uptake-table tr:hover {
            background: var(--mds-bg-tertiary);
        }
        
        .editable-offset {
            background: var(--mds-bg-primary);
            color: var(--mds-text-primary);
            border: 1px solid var(--mds-border-default);
            border-radius: 4px;
            padding: 4px 8px;
            width: 80px;
            font-size: 0.85rem;
            text-align: right;
        }
        
        .calculated-field {
            font-weight: 600;
            color: var(--maersk-blue);
        }
        
        .capacity-bar {
            width: 100px;
            height: 20px;
            background: var(--mds-bg-tertiary);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .capacity-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--maersk-success), var(--maersk-warning));
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .capacity-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--mds-text-primary);
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .status-indicator {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
        }
        
        .status-open { background: rgba(0, 170, 136, 0.2); color: var(--maersk-success); }
        .status-tight { background: rgba(255, 165, 0, 0.2); color: var(--maersk-warning); }
        .status-full { background: rgba(229, 62, 62, 0.2); color: var(--maersk-error); }
    </style>
</head>
<body>
    <header class="header">
        <h1>ðŸš¢ Vessel Uptake Dashboard</h1>
        <p>PENNY â†” DELTA Integration â€¢ Spot-Anchored Non-Spot Gating</p>
    </header>

    <div class="container">
        <!-- Vessel Overview -->
        <div style="background: var(--mds-bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid var(--mds-border-default);">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; align-items: center;">
                <div>
                    <h3 style="margin: 0 0 0.5rem 0; color: var(--mds-text-primary);">ðŸš¢ Vessel 412-W</h3>
                    <p style="margin: 0; color: var(--mds-text-secondary); font-size: 0.9rem;">Service Direction: Asia â†’ Europe</p>
                    <p style="margin: 0; color: var(--mds-text-secondary); font-size: 0.9rem;">Last Load Port: CNSGH</p>
                </div>
                <div style="text-align: center;">
                    <div style="color: var(--mds-text-secondary); font-size: 0.8rem; margin-bottom: 0.25rem;">Total Capacity</div>
                    <div style="color: var(--maersk-blue); font-size: 1.4rem; font-weight: 700;" id="totalCapacity">5,000 FFE</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: var(--mds-text-secondary); font-size: 0.8rem; margin-bottom: 0.25rem;">Current Booked</div>
                    <div style="color: var(--maersk-success); font-size: 1.4rem; font-weight: 700;" id="totalBooked">3,200 FFE</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: var(--mds-text-secondary); font-size: 0.8rem; margin-bottom: 0.25rem;">Forecast Final</div>
                    <div style="color: var(--maersk-light-blue); font-size: 1.4rem; font-weight: 700;" id="totalForecast">4,500 FFE</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: var(--mds-text-secondary); font-size: 0.8rem; margin-bottom: 0.25rem;">Current Remaining</div>
                    <div style="color: var(--maersk-warning); font-size: 1.4rem; font-weight: 700;" id="totalRemaining">1,800 FFE</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: var(--mds-text-secondary); font-size: 0.8rem; margin-bottom: 0.25rem;">Forecasted Remaining</div>
                    <div style="color: var(--mds-text-primary); font-size: 1.4rem; font-weight: 700;" id="forecastedRemaining">500 FFE</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: var(--mds-text-secondary); font-size: 0.8rem; margin-bottom: 0.25rem;">Current Utilization</div>
                    <div style="color: var(--mds-text-primary); font-size: 1.4rem; font-weight: 700;" id="utilization">64%</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: var(--mds-text-secondary); font-size: 0.8rem; margin-bottom: 0.25rem;">Forecasted Utilization</div>
                    <div style="color: var(--mds-text-primary); font-size: 1.4rem; font-weight: 700;" id="forecastedUtilization">90%</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: var(--mds-text-secondary); font-size: 0.8rem; margin-bottom: 0.25rem;">Total Remaining Expected CY</div>
                    <div style="color: var(--maersk-success); font-size: 1.4rem; font-weight: 700;" id="totalRemainingCY">$2,500,000</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: var(--mds-text-secondary); font-size: 0.8rem; margin-bottom: 0.25rem;">Vessel Status</div>
                    <div style="font-size: 1.2rem; font-weight: 700;" id="vesselStatus">
                        <div class="status-indicator status-tight">TIGHT</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trade Compartments Table -->
        <div style="background: var(--mds-bg-secondary); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--mds-border-default);">
            <h3 style="margin: 0 0 1rem 0; color: var(--mds-text-primary);">ðŸ“Š Trade Compartment Management</h3>
            <p style="margin: 0 0 1.5rem 0; color: var(--mds-text-secondary); font-size: 0.9rem;">
                Adjust DELTA offsets to control non-spot acceptance levels. Watch forecasts update in real-time above.
            </p>
            
            <table class="uptake-table">
                <thead>
                    <tr>
                        <th>Trade Code</th>
                        <th>Compartment FFE</th>
                        <th>Current Booked</th>
                        <th>Forecast Final</th>
                        <th>Current Remaining</th>
                        <th>Forecasted Remaining</th>
                        <th>Remaining Expected CY<br><small>(USD)</small></th>
                        <th>Spot CY Ref<br><small>(from PENNY)</small></th>
                        <th>DELTA Offset<br><small>(USD)</small></th>
                        <th>Non-Spot Min CY</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="tradesTableBody">
                    <!-- Trade rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Vessel Uptake Forecast Chart -->
        <div class="chart-container" style="margin: 2rem 0;">
            <h2 class="chart-title">Vessel Uptake Forecast - Stacked Trade Curves</h2>
            <p class="chart-subtitle">Real-time forecast impact of DELTA offset adjustments â€¢ Individual trade curves stack to vessel total</p>
            <div style="position: relative; height: 400px; width: 100%;">
                <canvas id="vesselUptakeChart"></canvas>
            </div>
        </div>

        <!-- PENNY Integration Status -->
        <div style="background: var(--mds-bg-secondary); padding: 1rem; border-radius: 8px; margin-top: 2rem; border: 1px solid var(--mds-border-default);">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--mds-text-primary);">ðŸ”— PENNY Integration Status</h4>
            <div style="display: flex; gap: 2rem; align-items: center; font-size: 0.9rem;">
                <div>
                    <span style="color: var(--mds-text-secondary);">Last PENNY Update:</span>
                    <span style="color: var(--maersk-blue); font-weight: 600; margin-left: 0.5rem;" id="lastPennyUpdate">2 minutes ago</span>
                </div>
                <div>
                    <span style="color: var(--mds-text-secondary);">Reference Corridors:</span>
                    <span style="color: var(--mds-text-primary); font-weight: 500; margin-left: 0.5rem;">CNSGHâ†’NLRTM, CNYTNâ†’DEHAM</span>
                </div>
                <div>
                    <span style="color: var(--mds-text-secondary);">DELTA Mode:</span>
                    <span style="color: var(--maersk-success); font-weight: 600; margin-left: 0.5rem;">ðŸŸ¢ Active</span>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div style="text-align: center; margin: 2rem 0;">
            <a href="live-pricing-advanced-simulator.html" style="display: inline-block; background: var(--mds-bg-strong); color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 500; margin-right: 1rem;">
                ðŸŽ® Advanced Simulator
            </a>
            <a href="live-pricing-simple.html" style="display: inline-block; background: var(--mds-bg-strong); color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 500; margin-right: 1rem;">
                ðŸ“Š Simple Simulator
            </a>
            <a href="index.html" style="display: inline-block; background: var(--mds-bg-strong); color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 500;">
                ðŸ“ˆ Historical Analysis
            </a>
        </div>
    </div>

    <script>
        // VESSEL UPTAKE CONFIGURATION WITH SIGMOID FORECASTING
        const VESSEL_CONFIG = {
            vessel: "412-W",
            serviceDirection: "Asia â†’ Europe", 
            lastLoadPort: "CNSGH",
            vesselCapacityFFE: 5000,
            
            // Time structure (35 days to departure)
            time: {
                dayPoints: [35, 32, 29, 26, 23, 20, 17, 14, 11, 8, 5, 2, 0],
                todayIndex: 8, // 11 days to departure
                get totalDataPoints() { return this.dayPoints.length; },
                get labels() { 
                    return this.dayPoints.map(days => `${days} days`); 
                }
            },
            
            // Trade data with sigmoid parameters (hidden from user)
            trades: [
                {
                    tradeCode: "E1W",
                    compartmentFFE: 2000,
                    bookedFFE: 1400,
                    refCorridors: [{ origin: "CNSGH", destination: "NLRTM" }],
                    cost: 1200,
                    // Hidden sigmoid parameters
                    sigmoid: { finalFFE: 2000, inflectionDay: 12, steepness: 0.25, sensitivity: -1.2 }
                },
                {
                    tradeCode: "E2W", 
                    compartmentFFE: 1500,
                    bookedFFE: 900,
                    refCorridors: [{ origin: "CNYTN", destination: "DEHAM" }],
                    cost: 1350,
                    sigmoid: { finalFFE: 1500, inflectionDay: 14, steepness: 0.30, sensitivity: -1.0 }
                },
                {
                    tradeCode: "W1FW",
                    compartmentFFE: 1000,
                    bookedFFE: 700,
                    refCorridors: [{ origin: "CNSGH", destination: "NLRTM" }],
                    cost: 1100,
                    sigmoid: { finalFFE: 1000, inflectionDay: 10, steepness: 0.35, sensitivity: -1.5 }
                },
                {
                    tradeCode: "X4FS",
                    compartmentFFE: 500,
                    bookedFFE: 200,
                    refCorridors: [{ origin: "CNYTN", destination: "DEHAM" }],
                    cost: 1250,
                    sigmoid: { finalFFE: 500, inflectionDay: 16, steepness: 0.20, sensitivity: -0.8 }
                }
            ],
            
            // Sample PENNY spot prices (from reference corridors)
            spotPrices: {
                "CNSGH-NLRTM": 2800,
                "CNYTN-DEHAM": 3200
            },
            
            // DELTA offsets (editable by uptake manager)
            deltaOffsets: {
                "E1W": 0,
                "E2W": 50,
                "W1FW": -25,
                "X4FS": 100
            }
        };

        // =================================================================
        // SIGMOID FORECASTING ENGINE (from live-pricing-simple)
        // =================================================================
        
        // Generate sigmoid booking curve for a single trade
        function generateTradeSigmoidCurve(trade, deltaOffsetImpact = 0) {
            const { finalFFE, inflectionDay, steepness, sensitivity } = trade.sigmoid;
            const curve = [];
            
            // Apply DELTA offset impact to final FFE (higher offset = lower bookings)
            const deltaMultiplier = Math.pow(1 + (deltaOffsetImpact / 1000), sensitivity);
            const adjustedFinalFFE = Math.max(finalFFE * deltaMultiplier, trade.bookedFFE);
            
            for (let i = 0; i < VESSEL_CONFIG.time.dayPoints.length; i++) {
                const daysOut = VESSEL_CONFIG.time.dayPoints[i];
                const t = 35 - daysOut; // Invert for sigmoid growth
                const inflectionPoint = 35 - inflectionDay;
                
                // Sigmoid function: FFE = finalFFE / (1 + e^(-steepness * (t - inflectionPoint)))
                const ffe = adjustedFinalFFE / (1 + Math.exp(-steepness * (t - inflectionPoint)));
                curve.push(Math.round(Math.max(ffe, 0)));
            }
            
            return curve;
        }
        
        // Generate uncertainty bands for a trade curve
        function generateTradeUncertaintyBands(baseCurve, tradeCode) {
            const todayIndex = VESSEL_CONFIG.time.todayIndex;
            const baseVariance = 0.03; // 3% base uncertainty
            const varianceGrowth = 0.02; // 2% additional per sqrt(days)
            
            const optimistic = baseCurve.map((value, index) => {
                if (index < todayIndex) return null; // Only forecast from today forward (include today)
                const daysFromToday = Math.abs(VESSEL_CONFIG.time.dayPoints[index] - VESSEL_CONFIG.time.dayPoints[todayIndex]);
                const uncertaintyFactor = baseVariance + varianceGrowth * Math.sqrt(daysFromToday);
                return Math.round(value * (1 + uncertaintyFactor));
            });
            
            const pessimistic = baseCurve.map((value, index) => {
                if (index < todayIndex) return null; // Only forecast from today forward (include today)
                const daysFromToday = Math.abs(VESSEL_CONFIG.time.dayPoints[index] - VESSEL_CONFIG.time.dayPoints[todayIndex]);
                const uncertaintyFactor = baseVariance + varianceGrowth * Math.sqrt(daysFromToday);
                return Math.round(value * (1 - uncertaintyFactor));
            });
            
            return { optimistic, pessimistic };
        }
        
        // Generate stacked vessel total from individual trade curves
        function generateVesselStackedCurves() {
            const tradeForecasts = {};
            const vesselTotal = { mostLikely: [], optimistic: [], pessimistic: [] };
            
            // Generate individual trade curves with DELTA offset impact
            VESSEL_CONFIG.trades.forEach(trade => {
                const deltaOffset = VESSEL_CONFIG.deltaOffsets[trade.tradeCode] || 0;
                const baseCurve = generateTradeSigmoidCurve(trade, deltaOffset);
                const uncertainty = generateTradeUncertaintyBands(baseCurve, trade.tradeCode);
                
                // Store individual trade forecasts
                tradeForecasts[trade.tradeCode] = {
                    mostLikely: baseCurve,
                    optimistic: uncertainty.optimistic,
                    pessimistic: uncertainty.pessimistic,
                    actual: baseCurve.map((value, index) => index <= VESSEL_CONFIG.time.todayIndex ? value : null)
                };
                
                // Add to vessel totals
                for (let i = 0; i < VESSEL_CONFIG.time.totalDataPoints; i++) {
                    vesselTotal.mostLikely[i] = (vesselTotal.mostLikely[i] || 0) + baseCurve[i];
                    
                    if (uncertainty.optimistic[i] !== null) {
                        vesselTotal.optimistic[i] = (vesselTotal.optimistic[i] || 0) + uncertainty.optimistic[i];
                    } else if (i < VESSEL_CONFIG.time.todayIndex) {
                        vesselTotal.optimistic[i] = null; // Historical points
                    } else if (vesselTotal.optimistic[i] === undefined) {
                        vesselTotal.optimistic[i] = 0; // Initialize for summation
                    }
                    
                    if (uncertainty.pessimistic[i] !== null) {
                        vesselTotal.pessimistic[i] = (vesselTotal.pessimistic[i] || 0) + uncertainty.pessimistic[i];
                    } else if (i < VESSEL_CONFIG.time.todayIndex) {
                        vesselTotal.pessimistic[i] = null; // Historical points
                    } else if (vesselTotal.pessimistic[i] === undefined) {
                        vesselTotal.pessimistic[i] = 0; // Initialize for summation
                    }
                }
            });
            
            return { tradeForecasts, vesselTotal };
        }
        
        // =================================================================
        // CHART INITIALIZATION AND UPDATES
        // =================================================================
        
        let vesselUptakeChart = null;
        
        function initVesselUptakeChart() {
            const ctx = document.getElementById('vesselUptakeChart');
            if (!ctx) return;
            
            const { tradeForecasts, vesselTotal } = generateVesselStackedCurves();
            const labels = VESSEL_CONFIG.time.labels;
            
            // Create datasets: Individual trades + Vessel total + Uncertainty bands
            const datasets = [];
            
            // Individual trade curves (actual + forecast + uncertainty)
            const tradeColors = {
                'E1W': 'rgb(0, 143, 211)',      // Maersk Blue
                'E2W': 'rgb(66, 176, 213)',     // Light Blue  
                'W1FW': 'rgb(0, 170, 136)',     // Success Green
                'X4FS': 'rgb(255, 165, 0)'      // Warning Orange
            };
            
            VESSEL_CONFIG.trades.forEach(trade => {
                const tradeCode = trade.tradeCode;
                const forecast = tradeForecasts[tradeCode];
                const color = tradeColors[tradeCode];
                
                // Individual Trade Uncertainty Bands (Pessimistic - lower bound)
                datasets.push({
                    label: `${tradeCode} Pessimistic`,
                    data: forecast.pessimistic,
                    borderColor: color.replace('rgb', 'rgba').replace(')', ', 0.5)'), // Slightly more visible
                    backgroundColor: 'transparent',
                    borderWidth: 1.5, // Slightly thicker
                    pointRadius: 0,
                    fill: false,
                    tension: 0.3,
                    borderDash: [3, 3], // More visible dash pattern
                    spanGaps: false
                });
                
                // Individual Trade Uncertainty Bands (Optimistic - upper bound with fill)
                datasets.push({
                    label: `${tradeCode} Optimistic`,
                    data: forecast.optimistic,
                    borderColor: color.replace('rgb', 'rgba').replace(')', ', 0.5)'), // Slightly more visible
                    backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.12)'), // Slightly more fill
                    borderWidth: 1.5, // Slightly thicker
                    pointRadius: 0,
                    fill: '-1', // Fill to previous dataset (pessimistic)
                    tension: 0.3,
                    borderDash: [3, 3], // More visible dash pattern
                    spanGaps: false
                });
                
                // Actual bookings (up to today)
                datasets.push({
                    label: `${tradeCode} Actual`,
                    data: forecast.actual,
                    borderColor: color,
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    pointRadius: 4,
                    pointBackgroundColor: color,
                    pointBorderColor: 'rgb(33, 33, 33)',
                    pointBorderWidth: 1,
                    fill: false,
                    tension: 0.3,
                    spanGaps: false
                });
                
                // Forecast (from today forward) - connect seamlessly to actual
                datasets.push({
                    label: `${tradeCode} Forecast`,
                    data: forecast.mostLikely.map((value, index) => 
                        index >= VESSEL_CONFIG.time.todayIndex ? value : null
                    ),
                    borderColor: color,
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    pointRadius: 3,
                    pointBackgroundColor: color,
                    pointBorderColor: 'rgb(33, 33, 33)',
                    pointBorderWidth: 1,
                    fill: false,
                    tension: 0.3,
                    borderDash: [6, 4],
                    spanGaps: false
                });
            });
            
            // Vessel Total Uncertainty Bands (more visible)
            datasets.push({
                label: 'Vessel Pessimistic',
                data: vesselTotal.pessimistic,
                borderColor: 'rgba(255, 100, 100, 0.8)', // Brighter red
                backgroundColor: 'transparent',
                borderWidth: 2,
                pointRadius: 0,
                fill: false,
                tension: 0.3,
                borderDash: [8, 4],
                spanGaps: false
            });
            
            datasets.push({
                label: 'Vessel Optimistic',
                data: vesselTotal.optimistic,
                borderColor: 'rgba(100, 255, 150, 0.8)', // Brighter green
                backgroundColor: 'rgba(100, 255, 150, 0.15)', // More visible fill
                borderWidth: 2,
                pointRadius: 0,
                fill: '-1', // Fill to previous dataset (Pessimistic)
                tension: 0.3,
                borderDash: [8, 4],
                spanGaps: false
            });
            
            // Vessel Capacity Line (dashed horizontal)
            const vesselCapacityLine = new Array(labels.length).fill(VESSEL_CONFIG.vesselCapacityFFE);
            datasets.push({
                label: 'Vessel Capacity',
                data: vesselCapacityLine,
                borderColor: 'rgba(255, 255, 255, 0.7)',
                backgroundColor: 'transparent',
                borderWidth: 2,
                pointRadius: 0,
                fill: false,
                tension: 0,
                borderDash: [12, 8],
                spanGaps: false
            });
            
            // Vessel Total - Actual (up to today)
            datasets.push({
                label: 'Vessel Total Actual',
                data: vesselTotal.mostLikely.map((value, index) => 
                    index <= VESSEL_CONFIG.time.todayIndex ? value : null
                ),
                borderColor: 'rgb(255, 255, 255)',
                backgroundColor: 'transparent',
                borderWidth: 5,
                pointRadius: 6,
                pointBackgroundColor: 'rgb(255, 255, 255)',
                pointBorderColor: 'rgb(33, 33, 33)',
                pointBorderWidth: 2,
                fill: false,
                tension: 0.3,
                spanGaps: false
            });
            
            // Vessel Total - Forecast (from today forward)
            datasets.push({
                label: 'Vessel Total Forecast',
                data: vesselTotal.mostLikely.map((value, index) => 
                    index >= VESSEL_CONFIG.time.todayIndex ? value : null
                ),
                borderColor: 'rgb(255, 255, 255)',
                backgroundColor: 'transparent',
                borderWidth: 5,
                pointRadius: 6,
                pointBackgroundColor: 'rgb(255, 255, 255)',
                pointBorderColor: 'rgb(33, 33, 33)',
                pointBorderWidth: 2,
                fill: false,
                tension: 0.3,
                borderDash: [10, 6],
                spanGaps: false
            });
            
            vesselUptakeChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 800 },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Days to Departure',
                                font: { size: 14, weight: '600' },
                                color: 'rgb(212, 212, 212)'
                            },
                            grid: { color: 'rgba(138, 138, 138, 0.3)' },
                            ticks: { color: 'rgb(138, 138, 138)' },
                            border: { color: 'rgb(76, 76, 76)' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Cumulative FFE',
                                font: { size: 14, weight: '600' },
                                color: 'rgb(212, 212, 212)'
                            },
                            beginAtZero: true,
                            max: 6000,
                            grid: { color: 'rgba(138, 138, 138, 0.3)' },
                            ticks: {
                                stepSize: 1000,
                                color: 'rgb(138, 138, 138)',
                                callback: function(value) {
                                    return (value / 1000).toFixed(0) + 'k';
                                }
                            },
                            border: { color: 'rgb(76, 76, 76)' }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: 'rgb(212, 212, 212)',
                                font: { size: 11, weight: '500' },
                                padding: 12,
                                usePointStyle: true,
                                filter: function(legendItem) {
                                    // Hide individual trade uncertainty bands from legend (keep vessel uncertainty)
                                    const hiddenLabels = ['E1W Pessimistic', 'E1W Optimistic', 'E2W Pessimistic', 'E2W Optimistic', 
                                                          'W1FW Pessimistic', 'W1FW Optimistic', 'X4FS Pessimistic', 'X4FS Optimistic'];
                                    return !hiddenLabels.includes(legendItem.text);
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(33, 33, 33, 0.95)',
                            titleColor: 'rgb(240, 240, 240)',
                            bodyColor: 'rgb(212, 212, 212)',
                            borderColor: 'rgb(76, 76, 76)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            padding: 12,
                            filter: function(tooltipItem) {
                                // Hide individual trade uncertainty and vessel capacity from tooltip
                                const hiddenInTooltip = [
                                    'E1W Pessimistic', 'E1W Optimistic', 'E2W Pessimistic', 'E2W Optimistic',
                                    'W1FW Pessimistic', 'W1FW Optimistic', 'X4FS Pessimistic', 'X4FS Optimistic',
                                    'Vessel Capacity'
                                ];
                                return !hiddenInTooltip.includes(tooltipItem.dataset.label);
                            },
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    if (value === null) return null;
                                    return `${context.dataset.label}: ${Math.round(value).toLocaleString()} FFE`;
                                }
                            }
                        }
                    },
                    interaction: { intersect: false, mode: 'index' }
                }
            });
            
            // Add TODAY vertical line
            if (vesselUptakeChart.options.plugins) {
                vesselUptakeChart.options.plugins.annotation = {
                    annotations: {
                        todayLine: {
                            type: 'line',
                            xMin: VESSEL_CONFIG.time.todayIndex,
                            xMax: VESSEL_CONFIG.time.todayIndex,
                            borderColor: 'rgba(255, 255, 255, 0.8)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                display: true,
                                content: 'TODAY',
                                position: 'start',
                                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                color: 'rgb(20, 20, 20)',
                                font: { size: 12, weight: 'bold' }
                            }
                        }
                    }
                };
            }
            
            console.log('Vessel Uptake Chart initialized with stacked forecasts');
        }
        
        // Update chart when DELTA offsets change
        function updateVesselUptakeChart() {
            if (!vesselUptakeChart) return;
            
            const { tradeForecasts, vesselTotal } = generateVesselStackedCurves();
            
            // Update individual trade datasets (now 4 datasets per trade: pessimistic, optimistic, actual, forecast)
            VESSEL_CONFIG.trades.forEach((trade, tradeIndex) => {
                const tradeCode = trade.tradeCode;
                const forecast = tradeForecasts[tradeCode];
                
                // Dataset indices: each trade has 4 datasets (pessimistic, optimistic, actual, forecast)
                const basePessimisticIndex = tradeIndex * 4;
                const baseOptimisticIndex = tradeIndex * 4 + 1;
                const baseActualIndex = tradeIndex * 4 + 2;
                const baseForecastIndex = tradeIndex * 4 + 3;
                
                // Update uncertainty bands
                if (vesselUptakeChart.data.datasets[basePessimisticIndex]) {
                    vesselUptakeChart.data.datasets[basePessimisticIndex].data = forecast.pessimistic;
                }
                if (vesselUptakeChart.data.datasets[baseOptimisticIndex]) {
                    vesselUptakeChart.data.datasets[baseOptimisticIndex].data = forecast.optimistic;
                }
                
                // Update actual and forecast
                if (vesselUptakeChart.data.datasets[baseActualIndex]) {
                    vesselUptakeChart.data.datasets[baseActualIndex].data = forecast.actual;
                }
                if (vesselUptakeChart.data.datasets[baseForecastIndex]) {
                    vesselUptakeChart.data.datasets[baseForecastIndex].data = 
                        forecast.mostLikely.map((value, index) => 
                            index >= VESSEL_CONFIG.time.todayIndex ? value : null
                        );
                }
            });
            
            // Update vessel total datasets (last 5 datasets: pessimistic, optimistic, capacity, actual, forecast)
            const totalDatasets = vesselUptakeChart.data.datasets.length;
            vesselUptakeChart.data.datasets[totalDatasets - 5].data = vesselTotal.pessimistic; // Vessel Pessimistic
            vesselUptakeChart.data.datasets[totalDatasets - 4].data = vesselTotal.optimistic;  // Vessel Optimistic  
            // Capacity line doesn't need updating (static)
            vesselUptakeChart.data.datasets[totalDatasets - 2].data = vesselTotal.mostLikely.map((value, index) => 
                index <= VESSEL_CONFIG.time.todayIndex ? value : null
            ); // Vessel Total Actual
            vesselUptakeChart.data.datasets[totalDatasets - 1].data = vesselTotal.mostLikely.map((value, index) => 
                index >= VESSEL_CONFIG.time.todayIndex ? value : null
            ); // Vessel Total Forecast
            
            vesselUptakeChart.update('none');
        }
        
        // =================================================================
        // TABLE AND OVERVIEW UPDATES
        // =================================================================
        
        // Calculate spot CY reference for a trade
        function calculateSpotCYRef(trade) {
            const corridorCYs = trade.refCorridors.map(corridor => {
                const corridorKey = `${corridor.origin}-${corridor.destination}`;
                const spotPrice = VESSEL_CONFIG.spotPrices[corridorKey] || 0;
                return spotPrice - trade.cost;
            });
            
            // Return median CY (for single corridor, just return the value)
            return corridorCYs.length > 0 ? corridorCYs[Math.floor(corridorCYs.length / 2)] : 0;
        }

        // Calculate non-spot minimum CY
        function calculateNonSpotMinCY(tradeCode, spotCYRef) {
            const deltaOffset = VESSEL_CONFIG.deltaOffsets[tradeCode] || 0;
            return spotCYRef + deltaOffset;
        }

        // Get capacity status based on forecasted remaining FFE
        function getCapacityStatus(forecastedRemaining) {
            if (forecastedRemaining < -50) return { class: 'status-full', text: 'OVERBOOK' }; // Red
            if (forecastedRemaining >= -50 && forecastedRemaining <= 50) return { class: 'status-full', text: 'FULL' }; // Red  
            if (forecastedRemaining > 50 && forecastedRemaining <= 75) return { class: 'status-tight', text: 'TIGHT' }; // Yellow
            return { class: 'status-open', text: 'OPEN' }; // Green
        }

        // Update DELTA offset and recalculate (with real-time chart updates)
        function updateDeltaOffset(tradeCode, newOffset) {
            VESSEL_CONFIG.deltaOffsets[tradeCode] = parseFloat(newOffset) || 0;
            console.log(`DELTA offset updated: ${tradeCode} = ${newOffset}`);
            
            // Update table with new forecast data
            renderTable();
            updateVesselOverview();
            
            // Update chart with new forecasts
            updateVesselUptakeChart();
        }

        // Render the trades table (using sigmoid-derived data)
        function renderTable() {
            const tbody = document.getElementById('tradesTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';
            
            // Generate current forecasts for all trades
            const { tradeForecasts } = generateVesselStackedCurves();

            VESSEL_CONFIG.trades.forEach(trade => {
                const tradeCode = trade.tradeCode;
                const forecast = tradeForecasts[tradeCode];
                
                // Get current booked (today's value from sigmoid)
                const currentBooked = forecast.mostLikely[VESSEL_CONFIG.time.todayIndex];
                
                // Get forecast final (end value from sigmoid)
                const forecastFinal = forecast.mostLikely[VESSEL_CONFIG.time.totalDataPoints - 1];
                
                // Calculate remaining values
                const currentRemaining = trade.compartmentFFE - currentBooked;
                const forecastedRemaining = trade.compartmentFFE - forecastFinal;
                
                // Calculate CY values
                const spotCYRef = calculateSpotCYRef(trade);
                const deltaOffset = VESSEL_CONFIG.deltaOffsets[trade.tradeCode] || 0;
                const nonSpotMinCY = calculateNonSpotMinCY(trade.tradeCode, spotCYRef);
                
                // Calculate remaining expected CY: (forecast final - current booked) * non-spot CY
                const remainingFFE = forecastFinal - currentBooked;
                const remainingExpectedCY = remainingFFE * nonSpotMinCY;
                
                const status = getCapacityStatus(forecastedRemaining); // Use forecasted remaining

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 600; color: var(--maersk-blue);">${trade.tradeCode}</td>
                    <td>${trade.compartmentFFE.toLocaleString()}</td>
                    <td style="font-weight: 600;">
                        ${currentBooked.toLocaleString()}
                        <div class="capacity-bar" style="margin-top: 4px;">
                            <div class="capacity-fill" style="width: ${Math.min(100, (currentBooked / trade.compartmentFFE * 100))}%;"></div>
                            <div class="capacity-text">${((currentBooked / trade.compartmentFFE) * 100).toFixed(1)}%</div>
                        </div>
                    </td>
                    <td style="color: var(--maersk-light-blue); font-weight: 600;">
                        ${forecastFinal.toLocaleString()}
                        <div class="capacity-bar" style="margin-top: 4px;">
                            <div class="capacity-fill" style="width: ${Math.min(100, (forecastFinal / trade.compartmentFFE * 100))}%; background: ${forecastFinal > trade.compartmentFFE ? 'linear-gradient(90deg, var(--maersk-warning), var(--maersk-error))' : 'linear-gradient(90deg, var(--maersk-success), var(--maersk-warning))'};"></div>
                            <div class="capacity-text">${((forecastFinal / trade.compartmentFFE) * 100).toFixed(1)}%</div>
                        </div>
                    </td>
                    <td style="color: ${currentRemaining > 0 ? 'var(--maersk-success)' : 'var(--maersk-error)'}; font-weight: 600;">
                        ${currentRemaining.toLocaleString()}
                    </td>
                    <td style="color: ${forecastedRemaining > 0 ? 'var(--maersk-success)' : 'var(--maersk-error)'}; font-weight: 600;">
                        ${forecastedRemaining.toLocaleString()}
                    </td>
                    <td style="color: ${remainingExpectedCY > 0 ? 'var(--maersk-success)' : 'var(--maersk-error)'}; font-weight: 700; font-size: 1.05em;">
                        $${remainingExpectedCY.toLocaleString()}
                        <div style="font-size: 0.7rem; color: var(--mds-text-weak);">
                            ${remainingFFE.toLocaleString()} FFE Ã— $${nonSpotMinCY.toLocaleString()}
                        </div>
                    </td>
                    <td style="color: var(--mds-text-secondary); font-weight: 500;">
                        $${spotCYRef.toLocaleString()}
                        <div style="font-size: 0.7rem; color: var(--mds-text-weak);">
                            ${trade.refCorridors.map(c => `${c.origin}â†’${c.destination}`).join(', ')}
                        </div>
                    </td>
                    <td>
                        <input type="number" 
                               class="editable-offset" 
                               value="${deltaOffset}"
                               step="25"
                               onchange="updateDeltaOffset('${trade.tradeCode}', this.value)"
                               oninput="updateDeltaOffset('${trade.tradeCode}', this.value)"
                               title="DELTA offset in USD - affects booking forecast">
                    </td>
                    <td class="calculated-field">$${nonSpotMinCY.toLocaleString()}</td>
                    <td>
                        <div class="status-indicator ${status.class}">${status.text}</div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update vessel overview metrics (using sigmoid-derived data)
        function updateVesselOverview() {
            const { vesselTotal, tradeForecasts } = generateVesselStackedCurves();
            
            const totalCapacity = VESSEL_CONFIG.trades.reduce((sum, trade) => sum + trade.compartmentFFE, 0);
            const totalBooked = vesselTotal.mostLikely[VESSEL_CONFIG.time.todayIndex]; // Current from sigmoid
            const totalForecast = vesselTotal.mostLikely[VESSEL_CONFIG.time.totalDataPoints - 1]; // Final forecast
            const totalRemaining = totalCapacity - totalBooked;
            const forecastedRemaining = totalCapacity - totalForecast;
            const utilization = ((totalBooked / totalCapacity) * 100).toFixed(1);
            const forecastedUtilization = ((totalForecast / totalCapacity) * 100).toFixed(1);

            // Calculate total remaining expected CY across all trades
            let totalRemainingCY = 0;
            VESSEL_CONFIG.trades.forEach(trade => {
                const tradeCode = trade.tradeCode;
                const forecast = tradeForecasts[tradeCode];
                const currentBooked = forecast.mostLikely[VESSEL_CONFIG.time.todayIndex];
                const forecastFinal = forecast.mostLikely[VESSEL_CONFIG.time.totalDataPoints - 1];
                const remainingFFE = forecastFinal - currentBooked;
                
                const spotCYRef = calculateSpotCYRef(trade);
                const nonSpotMinCY = calculateNonSpotMinCY(trade.tradeCode, spotCYRef);
                const remainingExpectedCY = remainingFFE * nonSpotMinCY;
                
                totalRemainingCY += remainingExpectedCY;
            });

            // Calculate vessel status based on forecasted remaining
            const vesselStatus = getCapacityStatus(forecastedRemaining);
            
            document.getElementById('totalCapacity').textContent = `${totalCapacity.toLocaleString()} FFE`;
            document.getElementById('totalBooked').textContent = `${totalBooked.toLocaleString()} FFE`;
            document.getElementById('totalForecast').textContent = `${totalForecast.toLocaleString()} FFE`;
            document.getElementById('totalRemaining').textContent = `${totalRemaining.toLocaleString()} FFE`;
            document.getElementById('forecastedRemaining').textContent = `${forecastedRemaining.toLocaleString()} FFE`;
            document.getElementById('utilization').textContent = `${utilization}%`;
            document.getElementById('forecastedUtilization').textContent = `${forecastedUtilization}%`;
            document.getElementById('totalRemainingCY').textContent = `$${totalRemainingCY.toLocaleString()}`;
            
            // Update vessel status
            const vesselStatusElement = document.getElementById('vesselStatus');
            if (vesselStatusElement) {
                vesselStatusElement.innerHTML = `<div class="status-indicator ${vesselStatus.class}">${vesselStatus.text}</div>`;
            }
        }

        // Simulate PENNY price updates (for demo)
        function simulatePennyUpdates() {
            // Add small random variations to spot prices
            Object.keys(VESSEL_CONFIG.spotPrices).forEach(corridor => {
                const currentPrice = VESSEL_CONFIG.spotPrices[corridor];
                const variation = (Math.random() - 0.5) * 0.02; // Â±1% variation
                VESSEL_CONFIG.spotPrices[corridor] = Math.round(currentPrice * (1 + variation));
            });

            renderTable();
            updateVesselUptakeChart(); // Update chart when PENNY prices change
            
            // Update timestamp
            document.getElementById('lastPennyUpdate').textContent = 'Just now';
            
            setTimeout(() => {
                document.getElementById('lastPennyUpdate').textContent = '1 minute ago';
            }, 60000);
        }

        // Initialize dashboard with full sigmoid forecasting system
        function initDashboard() {
            console.log('Initializing Vessel Uptake Dashboard with Sigmoid Forecasting...');
            
            // Initialize chart first
            initVesselUptakeChart();
            
            // Then render table and overview (which depend on chart data)
            renderTable();
            updateVesselOverview();
            
            // Simulate PENNY updates every 2 minutes
            setInterval(simulatePennyUpdates, 120000);
            
            console.log('Dashboard initialization complete!');
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            // Wait for Chart.js to load
            if (typeof Chart !== 'undefined') {
                initDashboard();
            } else {
                console.log('Chart.js not loaded, retrying in 500ms...');
                setTimeout(initDashboard, 500);
            }
        });
    </script>
</body>
</html>
