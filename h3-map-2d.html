<!DOCTYPE html>
<html>
<head>
    <meta charset='UTF-8'>
    <title>Rejected Offer Value - H3 Map</title>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <script src='https://unpkg.com/h3-js@4.1.0/dist/h3-js.umd.js'></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }
        #map {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(20, 20, 20, 0.95);
            color: rgb(240, 240, 240);
            padding: 1.5rem;
            border-radius: 8px;
            max-width: 350px;
            font-size: 0.9rem;
            z-index: 1;
            border: 1px solid rgb(76, 76, 76);
        }
        #info h3 {
            margin: 0 0 0.75rem 0;
            color: rgb(66, 176, 213);
            font-size: 1.1rem;
        }
        #info p {
            margin: 0.5rem 0;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }
        .label {
            color: rgb(212, 212, 212);
        }
        .value {
            color: rgb(66, 176, 213);
            font-weight: 600;
        }
        #legend {
            position: absolute;
            bottom: 40px;
            right: 20px;
            background: rgba(20, 20, 20, 0.95);
            color: rgb(240, 240, 240);
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            z-index: 1;
            border: 1px solid rgb(76, 76, 76);
        }
        .legend-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: rgb(212, 212, 212);
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 0.25rem 0;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 0.5rem;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="info">
        <h3>üó∫Ô∏è Rejected Offer Value by Region</h3>
        <div class="metric">
            <span class="label">Regions:</span>
            <span class="value" id="regionCount">Loading...</span>
        </div>
        <div class="metric">
            <span class="label">Total Rejected Value:</span>
            <span class="value" id="totalValue">-</span>
        </div>
        <div class="metric">
            <span class="label">Avg Non-Offer Ratio:</span>
            <span class="value" id="avgRatio">-</span>
        </div>
        <p style="font-size: 0.75rem; color: rgb(138, 138, 138); margin-top: 1rem;">
            Click hexagons for details
        </p>
    </div>
    
    <div id="legend">
        <div class="legend-title">Rejected Value (Sold Out)</div>
        <div class="legend-item">
            <div class="legend-color" style="background: #e74c3c;"></div>
            <span>High (&gt;$500k)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f39c12;"></div>
            <span>Medium ($100k-$500k)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #42b0d5;"></div>
            <span>Low (&lt;$100k)</span>
        </div>
    </div>
    
    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoid2lsaGVsbS1tYWVyc2siLCJhIjoiY2x0YzB6MngyMDdjNjJqcGQ4eTdpaW40diJ9.rJdvLdEbUb5p5SJTwZ0mZw';
        
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v10',
            center: [20, 30],
            zoom: 2,
            pitch: 0
        });

        // Load and visualize data
        async function loadData() {
            try {
                const response = await fetch('rejected_offer_value (29).csv');
                const text = await response.text();
                const lines = text.trim().split('\n');
                const headers = lines[0].split(',');
                
                const data = lines.slice(1).map(line => {
                    const values = line.split(',');
                    const row = {};
                    headers.forEach((header, i) => {
                        const val = values[i];
                        row[header] = (val === '' || val === 'null') ? null : (!isNaN(val) ? parseFloat(val) : val);
                    });
                    return row;
                }).filter(d => d.hex_h3_r2 && d.rejected_offer_value_vessel_sold_out != null);

                console.log('Loaded', data.length, 'regions');
                
                // Calculate summary stats
                const totalRejectedValue = data.reduce((sum, d) => sum + (d.rejected_offer_value_vessel_sold_out || 0), 0);
                const avgRatio = data.reduce((sum, d) => sum + (d.non_offer_ratio || 0), 0) / data.length;
                
                document.getElementById('regionCount').textContent = data.length.toLocaleString();
                document.getElementById('totalValue').textContent = '$' + (totalRejectedValue / 1000000).toFixed(1) + 'M';
                document.getElementById('avgRatio').textContent = (avgRatio * 100).toFixed(1) + '%';
                
                // Convert H3 hexagons to GeoJSON polygons
                map.on('load', () => {
                    const features = data.map(d => {
                        try {
                            const boundary = h3.cellToBoundary(d.hex_h3_r2, true);
                            const coordinates = [boundary.map(coord => [coord[1], coord[0]])];
                            
                            return {
                                type: 'Feature',
                                geometry: {
                                    type: 'Polygon',
                                    coordinates
                                },
                                properties: {
                                    hex_h3_r2: d.hex_h3_r2,
                                    booked_spot_total_freight: d.booked_spot_total_freight || 0,
                                    rejected_offer_value_vessel_sold_out: d.rejected_offer_value_vessel_sold_out || 0,
                                    booked_ffe: d.booked_ffe || 0,
                                    rejected_ffe: d.rejected_ffe || 0,
                                    non_offer_ratio: d.non_offer_ratio || 0
                                }
                            };
                        } catch (e) {
                            console.error('Error converting H3:', d.hex_h3_r2, e);
                            return null;
                        }
                    }).filter(f => f !== null);

                    map.addSource('h3-hexagons', {
                        type: 'geojson',
                        data: {
                            type: 'FeatureCollection',
                            features
                        }
                    });

                    // Add fill layer with color based on rejected value
                    map.addLayer({
                        id: 'hexagons-fill',
                        type: 'fill',
                        source: 'h3-hexagons',
                        paint: {
                            'fill-color': [
                                'interpolate',
                                ['linear'],
                                ['get', 'rejected_offer_value_vessel_sold_out'],
                                0, '#42b0d5',      // Blue (low)
                                100000, '#42b0d5',
                                500000, '#f39c12', // Orange (medium)
                                1000000, '#e74c3c' // Red (high)
                            ],
                            'fill-opacity': 0.7
                        }
                    });

                    // Add border layer
                    map.addLayer({
                        id: 'hexagons-border',
                        type: 'line',
                        source: 'h3-hexagons',
                        paint: {
                            'line-color': '#ffffff',
                            'line-width': 0.5,
                            'line-opacity': 0.3
                        }
                    });

                    // Add click interaction
                    map.on('click', 'hexagons-fill', (e) => {
                        const props = e.features[0].properties;
                        new mapboxgl.Popup()
                            .setLngLat(e.lngLat)
                            .setHTML(`
                                <div style="color: #333; padding: 0.5rem;">
                                    <div style="color: #42b0d5; font-weight: 600; margin-bottom: 0.5rem;">
                                        ${props.hex_h3_r2}
                                    </div>
                                    <div><strong>Booked Spot Freight:</strong> $${props.booked_spot_total_freight.toLocaleString()}</div>
                                    <div><strong>Rejected Value (Sold Out):</strong> $${props.rejected_offer_value_vessel_sold_out.toLocaleString()}</div>
                                    <div><strong>Booked FFE:</strong> ${props.booked_ffe.toLocaleString()}</div>
                                    <div><strong>Rejected FFE:</strong> ${props.rejected_ffe.toLocaleString()}</div>
                                    <div><strong>Non-Offer Ratio:</strong> ${(props.non_offer_ratio * 100).toFixed(1)}%</div>
                                </div>
                            `)
                            .addTo(map);
                    });

                    // Change cursor on hover
                    map.on('mouseenter', 'hexagons-fill', () => {
                        map.getCanvas().style.cursor = 'pointer';
                    });
                    
                    map.on('mouseleave', 'hexagons-fill', () => {
                        map.getCanvas().style.cursor = '';
                    });
                });

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('regionCount').textContent = 'Error loading data';
            }
        }

        loadData();
    </script>
</body>
</html>
