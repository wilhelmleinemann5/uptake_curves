<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Rejected Offer Value - Geospatial Analysis</title>
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/redux@4.2.1/dist/redux.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-redux@8.0.5/dist/react-redux.min.js" crossorigin></script>
    <script src="https://unpkg.com/keplergl@2.5.5/umd/keplergl.min.js" crossorigin></script>
    <link rel="stylesheet" href="https://unpkg.com/keplergl@2.5.5/umd/keplergl.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }
        #app {
            position: absolute;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <script>
        // Kepler.gl configuration for H3 hexagon visualization
        const config = {
            version: 'v1',
            config: {
                visState: {
                    filters: [],
                    layers: [{
                        id: 'h3-layer',
                        type: 'hexagonId',
                        config: {
                            dataId: 'rejected_offers',
                            label: 'Rejected Offer Value by Region',
                            color: [255, 0, 0],
                            columns: {
                                hex_id: 'hex_h3_r2'
                            },
                            isVisible: true,
                            visConfig: {
                                opacity: 0.8,
                                colorRange: {
                                    name: 'ColorBrewer RdYlGn-6',
                                    type: 'diverging',
                                    category: 'ColorBrewer',
                                    colors: ['#d73027', '#fc8d59', '#fee08b', '#d9ef8b', '#91cf60', '#1a9850'],
                                    reversed: true
                                },
                                coverage: 1,
                                enable3d: true,
                                sizeRange: [0, 500],
                                coverageRange: [0, 1],
                                elevationScale: 50,
                                enableElevationZoomFactor: true
                            },
                            heightField: {
                                name: 'rejected_offer_value',
                                type: 'real'
                            },
                            colorField: {
                                name: 'rejected_offer_value',
                                type: 'real'
                            },
                            colorScale: 'quantize'
                        }
                    }],
                    interactionConfig: {
                        tooltip: {
                            fieldsToShow: {
                                rejected_offers: [
                                    {name: 'hex_h3_r2', format: null},
                                    {name: 'rejected_offer_value', format: null},
                                    {name: 'booked_ffe', format: null},
                                    {name: 'offered_ffe', format: null},
                                    {name: 'rejected_ffe', format: null},
                                    {name: 'non_offer_ratio', format: null}
                                ]
                            },
                            compareMode: false,
                            compareType: 'absolute',
                            enabled: true
                        },
                        brush: {
                            size: 0.5,
                            enabled: false
                        },
                        geocoder: {
                            enabled: true
                        },
                        coordinate: {
                            enabled: false
                        }
                    },
                    layerBlending: 'normal',
                    splitMaps: [],
                    animationConfig: {
                        currentTime: null,
                        speed: 1
                    }
                },
                mapState: {
                    bearing: 0,
                    dragRotate: true,
                    latitude: 25,
                    longitude: 0,
                    pitch: 50,
                    zoom: 2,
                    isSplit: false
                },
                mapStyle: {
                    styleType: 'dark',
                    topLayerGroups: {},
                    visibleLayerGroups: {
                        label: true,
                        road: true,
                        border: false,
                        building: true,
                        water: true,
                        land: true,
                        '3d building': false
                    },
                    threeDBuildingColor: [9.665468314072013, 17.18305478057247, 31.1442867897876],
                    mapStyles: {}
                }
            }
        };

        // Load CSV data
        async function loadData() {
            try {
                const response = await fetch('rejected_offer_value (29).csv');
                const csvText = await response.text();
                
                // Parse CSV
                const lines = csvText.trim().split('\n');
                const headers = lines[0].split(',');
                
                const data = lines.slice(1).map(line => {
                    const values = line.split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        const value = values[index];
                        // Convert numeric fields
                        if (!isNaN(value) && value !== '' && value !== 'null') {
                            row[header] = parseFloat(value);
                        } else {
                            row[header] = value;
                        }
                    });
                    return row;
                });

                // Initialize Kepler.gl
                const KeplerGl = window.KeplerGl;
                const keplerGlReducer = window.keplerGl.keplerGlReducer;
                
                const store = Redux.createStore(
                    Redux.combineReducers({
                        keplerGl: keplerGlReducer
                    }),
                    {}
                );

                const app = ReactDOM.createRoot(document.getElementById('app'));
                
                app.render(
                    React.createElement(
                        ReactRedux.Provider,
                        { store },
                        React.createElement(KeplerGl, {
                            id: 'map',
                            mapboxApiAccessToken: 'pk.eyJ1Ijoid2lsaGVsbS1tYWVyc2siLCJhIjoiY2x0YzB6MngyMDdjNjJqcGQ4eTdpaW40diJ9.rJdvLdEbUb5p5SJTwZ0mZw',
                            width: window.innerWidth,
                            height: window.innerHeight
                        })
                    )
                );

                // Add data to Kepler
                setTimeout(() => {
                    store.dispatch(
                        window.keplerGl.addDataToMap({
                            datasets: {
                                info: {
                                    label: 'Rejected Offers by Region',
                                    id: 'rejected_offers'
                                },
                                data: {
                                    fields: headers.map(name => ({
                                        name,
                                        type: name.includes('ffe') || name.includes('value') || name.includes('ratio') ? 'real' : 'string'
                                    })),
                                    rows: data
                                }
                            },
                            options: {
                                centerMap: true,
                                readOnly: false
                            },
                            config
                        })
                    );
                }, 1000);

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('app').innerHTML = `
                    <div style="padding: 2rem; color: #e74c3c;">
                        <h2>Error Loading Data</h2>
                        <p>${error.message}</p>
                        <p>Make sure the CSV file is in the same directory as this HTML file.</p>
                    </div>
                `;
            }
        }

        // Load data when page loads
        window.addEventListener('load', loadData);
    </script>
</body>
</html>
