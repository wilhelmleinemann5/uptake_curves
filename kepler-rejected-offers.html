<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Rejected Offer Value - Geospatial Analysis</title>
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/redux@4.2.0/dist/redux.js"></script>
    <script src="https://unpkg.com/react-redux@8.0.5/dist/react-redux.js"></script>
    <script src="https://unpkg.com/styled-components@5.3.6/dist/styled-components.min.js"></script>
    <script src="https://unpkg.com/kepler.gl@2.5.5/umd/keplergl.min.js"></script>
    <link href="https://unpkg.com/kepler.gl@2.5.5/umd/keplergl.min.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #app {
            position: absolute;
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <script>
        (async function() {
            const KeplerGl = window.KeplerGl.KeplerGl;
            const {addDataToMap} = window.KeplerGl.Actions;
            
            // Fetch and parse CSV
            const response = await fetch('rejected_offer_value (29).csv');
            const text = await response.text();
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',');
            
            const rows = lines.slice(1).map(line => {
                const values = line.split(',');
                return headers.reduce((obj, header, i) => {
                    const val = values[i];
                    obj[header] = (val === '' || val === 'null') ? null : (!isNaN(val) ? parseFloat(val) : val);
                    return obj;
                }, {});
            });

            const fields = headers.map(name => ({
                name,
                type: ['booked_ffe', 'booked_spot_total_freight', 'offered_ffe', 'rejected_ffe', 
                       'rejected_offer_value', 'rejected_offer_value_vessel_sold_out', 
                       'rejected_offer_value_vessel_not_open', 'non_offer_ratio'].includes(name) ? 'real' : 'string'
            }));

            const store = Redux.createStore(
                Redux.combineReducers({
                    keplerGl: window.KeplerGl.keplerGlReducer
                }),
                {}
            );

            const Component = () => React.createElement(
                ReactRedux.Provider,
                {store},
                React.createElement(KeplerGl, {
                    id: 'map',
                    mapboxApiAccessToken: 'pk.eyJ1Ijoid2lsaGVsbS1tYWVyc2siLCJhIjoiY2x0YzB6MngyMDdjNjJqcGQ4eTdpaW40diJ9.rJdvLdEbUb5p5SJTwZ0mZw',
                    width: window.innerWidth,
                    height: window.innerHeight
                })
            );

            ReactDOM.render(React.createElement(Component), document.getElementById('app'));

            const config = {
                version: 'v1',
                config: {
                    visState: {
                        layers: [{
                            id: 'h3-hexagons',
                            type: 'hexagonId',
                            config: {
                                dataId: 'rejected_offers',
                                label: 'Rejected Offers by Region',
                                columns: {
                                    hex_id: 'hex_h3_r2'
                                },
                                isVisible: true,
                                visConfig: {
                                    opacity: 0.8,
                                    colorRange: {
                                        name: 'Global Warming',
                                        type: 'sequential',
                                        category: 'Uber',
                                        colors: ['#5A1846', '#900C3F', '#C70039', '#E3611C', '#F1920E', '#FFC300']
                                    },
                                    coverage: 1,
                                    enable3d: true,
                                    sizeRange: [0, 500],
                                    elevationScale: 20,
                                    enableElevationZoomFactor: true
                                },
                                colorField: {
                                    name: 'rejected_offer_value_vessel_sold_out',
                                    type: 'real'
                                },
                                heightField: {
                                    name: 'booked_spot_total_freight',
                                    type: 'real'
                                },
                                colorScale: 'quantize'
                            }
                        }],
                        interactionConfig: {
                            tooltip: {
                                fieldsToShow: {
                                    rejected_offers: [
                                        {name: 'hex_h3_r2', format: null},
                                        {name: 'booked_spot_total_freight', format: null},
                                        {name: 'rejected_offer_value_vessel_sold_out', format: null},
                                        {name: 'booked_ffe', format: null},
                                        {name: 'rejected_ffe', format: null},
                                        {name: 'non_offer_ratio', format: null}
                                    ]
                                },
                                enabled: true
                            }
                        }
                    },
                    mapState: {
                        latitude: 30,
                        longitude: 20,
                        zoom: 2,
                        pitch: 45,
                        bearing: 0
                    },
                    mapStyle: {
                        styleType: 'dark'
                    }
                }
            };

            setTimeout(() => {
                store.dispatch(addDataToMap({
                    datasets: {
                        info: {
                            label: 'Rejected Offers',
                            id: 'rejected_offers'
                        },
                        data: {
                            fields,
                            rows
                        }
                    },
                    options: {
                        centerMap: true
                    },
                    config
                }));
            }, 1000);
        })();
    </script>
</body>
</html>