<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OD Pricing Dashboard - Reference-Corridor Anchored</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <link rel="stylesheet" href="styles/maersk-theme.css">
    <style>
        .control-panel {
            background: var(--mds-bg-secondary);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 1px solid var(--mds-border-default);
        }
        
        .control-group {
            display: flex;
            gap: 2rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .control-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .control-item label {
            color: var(--mds-text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .control-item select,
        .control-item input {
            background: var(--mds-bg-primary);
            color: var(--mds-text-primary);
            border: 1px solid var(--mds-border-default);
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 0.9rem;
            min-width: 120px;
        }
        
        .reference-section {
            background: var(--mds-bg-tertiary);
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid var(--maersk-blue);
        }
        
        .filters-panel {
            background: var(--mds-bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--mds-border-default);
            min-height: 400px;
        }
        
        .filter-group {
            margin-bottom: 1.5rem;
        }
        
        .filter-group h4 {
            color: var(--mds-text-primary);
            font-size: 0.9rem;
            margin: 0 0 0.5rem 0;
        }
        
        .toggle-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .toggle-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .toggle-item input[type="checkbox"] {
            accent-color: var(--maersk-blue);
        }
        
        .toggle-item label {
            color: var(--mds-text-secondary);
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>üéØ OD Pricing Dashboard</h1>
        <p>Reference-Corridor Anchored Pricing ‚Ä¢ Set intercept from reference corridor target</p>
    </header>

    <div class="container">
        <!-- Intercept Timeline (Strategic Overview) -->
        <div class="chart-container" style="margin-bottom: 1rem;">
            <h2 class="chart-title">Weekly Intercept Timeline - E1W Trade</h2>
            <p class="chart-subtitle">Historical intercepts (8 weeks) + Future planning (4 weeks) ‚Ä¢ Click to select week for detailed OD analysis below</p>
            <div style="position: relative; height: 200px; width: 100%;">
                <canvas id="interceptTimelineChart"></canvas>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <div class="control-group">
                <div class="control-item">
                    <label>Product</label>
                    <select id="productSelect">
                        <option value="SPOT" selected>SPOT</option>
                        <option value="CONTRACT">CONTRACT</option>
                    </select>
                </div>
                
                <div class="control-item">
                    <label>Trade</label>
                    <select id="tradeSelect">
                        <option value="E1W" selected>E1W</option>
                        <option value="E2W">E2W</option>
                        <option value="W1FW">W1FW</option>
                        <option value="X4FS">X4FS</option>
                    </select>
                </div>
                
                <div class="control-item">
                    <label>Departure Week</label>
                    <select id="weekSelect" onchange="selectWeek(this.value)">
                        <option value="2025-29">2025-29</option>
                        <option value="2025-30">2025-30</option>
                        <option value="2025-31">2025-31</option>
                        <option value="2025-32">2025-32</option>
                        <option value="2025-33">2025-33</option>
                        <option value="2025-34">2025-34</option>
                        <option value="2025-35">2025-35</option>
                        <option value="2025-36">2025-36</option>
                        <option value="2025-37" selected>2025-37</option>
                        <option value="2025-38">2025-38</option>
                        <option value="2025-39">2025-39</option>
                        <option value="2025-40">2025-40</option>
                        <option value="2025-41">2025-41</option>
                    </select>
                </div>
            </div>
            
            <!-- Reference Corridor Section -->
            <div class="reference-section">
                <h4 style="margin: 0 0 1rem 0; color: var(--mds-text-primary);">üìç Reference Corridor (Sets Weekly Intercept)</h4>
                <div class="control-group" style="margin-bottom: 0;">
                    <div class="control-item">
                        <label>Reference Corridor</label>
                        <select id="referenceCorridorSelect">
                            <option value="CNSGH-NLROT" selected>CNSGH ‚Üí NLROT</option>
                            <option value="CNSGH-DEHAM">CNSGH ‚Üí DEHAM</option>
                            <option value="CNSGH-BEANR">CNSGH ‚Üí BEANR</option>
                        </select>
                    </div>
                    
                    <div class="control-item">
                        <label>Target Price ($/FFE)</label>
                        <input type="number" id="targetPriceInput" value="1700" min="1000" max="3000" step="10">
                    </div>
                    
                    <div class="control-item">
                        <label>Current PENNY Price</label>
                        <input type="number" id="currentPennyPrice" value="1680" disabled style="opacity: 0.7;">
                    </div>
                    
                    <div class="control-item">
                        <button id="usePennyPriceBtn" style="background: var(--maersk-light-blue); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 1.5rem;">
                            Use PENNY Price
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content Layout -->
        <div style="display: grid; grid-template-columns: 1fr 300px; gap: 2rem;">
            <!-- Chart Area -->
            <div class="chart-container">
                <h2 class="chart-title">OD Pricing Model - E1W Trade</h2>
                <p class="chart-subtitle">X-axis: OD Rank (0=cheapest, 1=most expensive) ‚Ä¢ Y-axis: Price per FFE ‚Ä¢ Bubble size: Booked volume</p>
                <div style="position: relative; height: 500px; width: 100%;">
                    <canvas id="odPricingChart"></canvas>
                </div>
                
                <!-- Model Info -->
                <div style="background: var(--mds-bg-tertiary); padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: var(--mds-text-primary);">üìä Model Parameters</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.9rem;">
                        <div>
                            <span style="color: var(--mds-text-secondary);">Trade Slope (Œ≤):</span>
                            <span style="color: var(--mds-text-primary); font-weight: 600; margin-left: 0.5rem;" id="tradeSlopeDisplay">0.45</span>
                        </div>
                        <div>
                            <span style="color: var(--mds-text-secondary);">Weekly Intercept (Œ±):</span>
                            <span style="color: var(--mds-text-primary); font-weight: 600; margin-left: 0.5rem;" id="weeklyInterceptDisplay">$1,700</span>
                        </div>
                        <div>
                            <span style="color: var(--mds-text-secondary);">Reference Rank:</span>
                            <span style="color: var(--mds-text-primary); font-weight: 600; margin-left: 0.5rem;" id="referenceRankDisplay">0.12</span>
                        </div>
                        <div>
                            <span style="color: var(--mds-text-secondary);">Model: price = Œ± √ó exp(Œ≤ √ó rank)</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filters Panel -->
            <div class="filters-panel">
                <h3 style="margin: 0 0 1rem 0; color: var(--mds-text-primary);">üîç Filters & Display</h3>
                
                <div class="filter-group">
                    <h4>Origin Filters</h4>
                    <select id="originFilter" style="width: 100%;">
                        <option value="all">All Origins</option>
                        <option value="CNSGH">CNSGH - Shanghai</option>
                        <option value="CNNPO">CNNPO - Ningbo</option>
                        <option value="CNIWN">CNIWN - Shekou</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <h4>Destination Filters</h4>
                    <select id="destinationFilter" style="width: 100%;">
                        <option value="all">All Destinations</option>
                        <option value="NLROT">NLROT - Rotterdam</option>
                        <option value="DEHAM">DEHAM - Hamburg</option>
                        <option value="BEANT">BEANT - Antwerp</option>
                        <option value="FRLEH">FRLEH - Le Havre</option>
                        <option value="GBSOU">GBSOU - Southampton</option>
                        <option value="PLGDN">PLGDN - Gdansk</option>
                        <option value="NOOSL">NOOSL - Oslo</option>
                        <option value="SEGOT">SEGOT - Gothenburg</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <h4>Volume Filter</h4>
                    <select id="volumeFilter" style="width: 100%;">
                        <option value="all">All ODs</option>
                        <option value="with_bookings">ODs with Bookings > 1</option>
                        <option value="top_20">Top 20 by Volume</option>
                        <option value="bottom_20">Bottom 20 by Volume</option>
                    </select>
                </div>
                
            </div>
        </div>
        
        <!-- Navigation -->
        <div style="text-align: center; margin: 2rem 0;">
            <a href="vessel-uptake-dashboard.html" style="display: inline-block; background: var(--mds-bg-strong); color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 500; margin-right: 1rem;">
                üö¢ Vessel Uptake Dashboard
            </a>
            <a href="live-pricing-simple.html" style="display: inline-block; background: var(--mds-bg-strong); color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 500; margin-right: 1rem;">
                üìä Simple Simulator
            </a>
            <a href="index.html" style="display: inline-block; background: var(--mds-bg-strong); color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 500;">
                üìà Historical Analysis
            </a>
        </div>
    </div>

    <script>
        // =================================================================
        // OD PRICING CONFIGURATION AND DATA
        // =================================================================
        
        const OD_PRICING_CONFIG = {
            // Trade configuration
            trades: {
                'E1W': {
                    name: 'E1W - Asia to North Europe',
                    beta_slope: 0.45,  // Trade slope (learned from history)
                    reference_corridor: 'CNSGH-NLROT',
                    reference_rank: 0.12
                }
            },
            
            // Multi-week intercept data (8 historical + 4 future)
            weekly_intercepts: {
                // Historical weeks (already sailed)
                '2025-29': { intercept: 1520, status: 'historical', reference_price: 1650 },
                '2025-30': { intercept: 1580, status: 'historical', reference_price: 1710 },
                '2025-31': { intercept: 1540, status: 'historical', reference_price: 1670 },
                '2025-32': { intercept: 1610, status: 'historical', reference_price: 1740 },
                '2025-33': { intercept: 1590, status: 'historical', reference_price: 1720 },
                '2025-34': { intercept: 1570, status: 'historical', reference_price: 1700 },
                '2025-35': { intercept: 1600, status: 'historical', reference_price: 1730 },
                '2025-36': { intercept: 1580, status: 'historical', reference_price: 1710 },
                
                // Current week
                '2025-37': { intercept: 1611, status: 'current', reference_price: 1700 },
                
                // Future weeks (planning) - intercept will be set when user defines target price
                '2025-38': { intercept: 1580, status: 'future', reference_price: 1680 },
                '2025-39': { intercept: 1590, status: 'future', reference_price: 1690 },
                '2025-40': { intercept: 1600, status: 'future', reference_price: 1700 },
                '2025-41': { intercept: 1610, status: 'future', reference_price: 1710 }
            },
            
            // Current selected week for detailed view
            selected_week: '2025-37',
            
            // OD structure for E1W trade (ranks and corridors only)
            od_structure: [
                { origin: 'CNSGH', destination: 'NLROT', od_rank: 0.12 }, // Reference
                { origin: 'CNSGH', destination: 'DEHAM', od_rank: 0.18 },
                { origin: 'CNSGH', destination: 'BEANT', od_rank: 0.25 },
                { origin: 'CNSGH', destination: 'FRLEH', od_rank: 0.32 },
                { origin: 'CNNPO', destination: 'NLROT', od_rank: 0.15 },
                { origin: 'CNNPO', destination: 'DEHAM', od_rank: 0.22 },
                { origin: 'CNNPO', destination: 'BEANT', od_rank: 0.28 },
                { origin: 'CNNPO', destination: 'FRLEH', od_rank: 0.35 },
                { origin: 'CNIWN', destination: 'NLROT', od_rank: 0.20 },
                { origin: 'CNIWN', destination: 'DEHAM', od_rank: 0.26 },
                { origin: 'CNIWN', destination: 'BEANT', od_rank: 0.35 },
                { origin: 'CNIWN', destination: 'FRLEH', od_rank: 0.42 },
                { origin: 'CNSGH', destination: 'GBSOU', od_rank: 0.45 },
                { origin: 'CNSGH', destination: 'PLGDN', od_rank: 0.52 },
                { origin: 'CNNPO', destination: 'GBSOU', od_rank: 0.48 },
                { origin: 'CNNPO', destination: 'PLGDN', od_rank: 0.55 },
                { origin: 'CNIWN', destination: 'GBSOU', od_rank: 0.58 },
                { origin: 'CNIWN', destination: 'PLGDN', od_rank: 0.65 },
                { origin: 'CNSGH', destination: 'NOOSL', od_rank: 0.72 },
                { origin: 'CNSGH', destination: 'SEGOT', od_rank: 0.78 },
                { origin: 'CNNPO', destination: 'NOOSL', od_rank: 0.75 },
                { origin: 'CNNPO', destination: 'SEGOT', od_rank: 0.82 },
                { origin: 'CNIWN', destination: 'NOOSL', od_rank: 0.85 },
                { origin: 'CNIWN', destination: 'SEGOT', od_rank: 0.92 }
            ],
            
            // Noise parameters for booking generation
            noise: {
                priceStdDev: 0.20,  // 20% price noise (increased for more scatter)
                volumeParams: { min: 5, max: 60, concentration: 0.3 } // Volume distribution
            },
            
            // Historical residual bands (by rank bins)
            acceptable_bands: [
                { rank_min: 0.0, rank_max: 0.2, band_low_pct: 0.85, band_high_pct: 1.15 },
                { rank_min: 0.2, rank_max: 0.4, band_low_pct: 0.82, band_high_pct: 1.18 },
                { rank_min: 0.4, rank_max: 0.6, band_low_pct: 0.80, band_high_pct: 1.20 },
                { rank_min: 0.6, rank_max: 0.8, band_low_pct: 0.78, band_high_pct: 1.22 },
                { rank_min: 0.8, rank_max: 1.0, band_low_pct: 0.75, band_high_pct: 1.25 }
            ]
        };
        
        // =================================================================
        // PRICING MODEL LOGIC
        // =================================================================
        
        // Calculate weekly intercept from reference corridor target price
        function calculateWeeklyIntercept(targetPrice, referenceRank, beta) {
            // Solve: targetPrice = alpha * exp(beta * referenceRank)
            // Therefore: alpha = targetPrice / exp(beta * referenceRank)
            return targetPrice / Math.exp(beta * referenceRank);
        }
        
        // Calculate predicted price for any OD
        function calculatePredictedPrice(alpha, beta, odRank) {
            // price = alpha * exp(beta * rank)
            return alpha * Math.exp(beta * odRank);
        }
        
        // Generate realistic booking data from parameterized model + noise
        function generateBookingData() {
            const bookings = [];
            const selectedWeek = OD_PRICING_CONFIG.selected_week;
            const weekData = OD_PRICING_CONFIG.weekly_intercepts[selectedWeek];
            const baseAlpha = weekData.intercept; // Use week-specific intercept
            const baseBeta = 0.45;  // Same as trade slope
            
            // Seeded random for reproducible results (vary by week)
            let seed = 12345 + parseInt(selectedWeek.split('-')[1]); // Week-specific seed
            function seededRandom() {
                seed = (seed * 9301 + 49297) % 233280;
                return seed / 233280;
            }
            
            // Reduce bookings for future weeks (haven't fully realized yet)
            const isFutureWeek = weekData.status === 'future';
            const bookingMultiplier = isFutureWeek ? 0.3 : 1.0; // 30% of normal bookings for future
            
            OD_PRICING_CONFIG.od_structure.forEach(od => {
                // Base price from parameterized model
                const basePrice = baseAlpha * Math.exp(baseBeta * od.od_rank);
                
                // Generate fewer booking events for future weeks
                const baseNumBookings = Math.floor(seededRandom() * 4) + 3;
                const numBookings = Math.max(1, Math.floor(baseNumBookings * bookingMultiplier));
                
                for (let i = 0; i < numBookings; i++) {
                    // Add noise to price (log-normal to stay positive)
                    const priceNoise = 1 + (seededRandom() - 0.5) * OD_PRICING_CONFIG.noise.priceStdDev * 2;
                    const noisyPrice = Math.round(basePrice * priceNoise);
                    
                    // Generate realistic volume (higher volume for lower ranks)
                    const volumeBase = Math.max(5, 80 * Math.exp(-od.od_rank * 2)); // Exponential decay
                    const volumeNoise = 0.5 + seededRandom();
                    const volume = Math.round(volumeBase * volumeNoise * bookingMultiplier);
                    
                    bookings.push({
                        origin: od.origin,
                        destination: od.destination,
                        od_rank: od.od_rank,
                        current_price: noisyPrice,
                        booked_volume: volume
                    });
                }
            });
            
            return bookings;
        }
        
        // Calculate parameterized line-of-best-fit (no fitting needed - we know the parameters)
        function calculateParameterizedBestFit() {
            const baseAlpha = 1580;
            const baseBeta = 0.45;
            
            const bestFitLine = [];
            for (let rank = 0; rank <= 1; rank += 0.02) {
                bestFitLine.push({
                    rank: rank,
                    bestFitPrice: baseAlpha * Math.exp(baseBeta * rank)
                });
            }
            
            return { bestFitLine, alpha: baseAlpha, beta: baseBeta };
        }
        
        // Calculate OLS line-of-best-fit from booking data (covers full 0-1 range)
        function calculateOLSBestFit(odData) {
            // Simple OLS regression: price = a + b * rank
            const n = odData.length;
            const sumX = odData.reduce((sum, od) => sum + od.od_rank, 0);
            const sumY = odData.reduce((sum, od) => sum + od.current_price, 0);
            const sumXY = odData.reduce((sum, od) => sum + (od.od_rank * od.current_price), 0);
            const sumXX = odData.reduce((sum, od) => sum + (od.od_rank * od.od_rank), 0);
            
            // OLS coefficients
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            // Generate continuous line from 0 to 1
            const bestFitLine = [];
            for (let rank = 0; rank <= 1; rank += 0.02) {
                bestFitLine.push({
                    rank: rank,
                    bestFitPrice: intercept + slope * rank
                });
            }
            
            // Calculate residuals for band calculation
            const residuals = odData.map(od => {
                const predicted = intercept + slope * od.od_rank;
                return Math.abs(od.current_price - predicted);
            });
            
            // Use 80th percentile of residuals for band width
            residuals.sort((a, b) => a - b);
            const bandWidth = residuals[Math.floor(residuals.length * 0.8)];
            
            return { bestFitLine, bandWidth, slope, intercept };
        }
        
        // Calculate acceptable band based on line-of-best-fit (static, doesn't move with intercept)
        function calculateAcceptableBand(bestFitPrice, bandWidth) {
            return {
                low: bestFitPrice - bandWidth,
                high: bestFitPrice + bandWidth
            };
        }
        
        // =================================================================
        // CHART INITIALIZATION AND UPDATES
        // =================================================================
        
        let interceptTimelineChart = null;
        let odPricingChart = null;
        
        function initInterceptTimelineChart() {
            const ctx = document.getElementById('interceptTimelineChart');
            if (!ctx) return;
            
            const weeks = Object.keys(OD_PRICING_CONFIG.weekly_intercepts).sort();
            const interceptData = weeks.map(week => {
                const weekData = OD_PRICING_CONFIG.weekly_intercepts[week];
                return {
                    x: week,
                    y: weekData.intercept || weekData.reference_price, // Use reference price for future weeks
                    status: weekData.status,
                    reference_price: weekData.reference_price,
                    week: week
                };
            });
            
            // Create one continuous line connecting all points
            const datasets = [
                {
                    label: 'Intercept Timeline',
                    data: interceptData,
                    borderColor: 'rgba(138, 138, 138, 0.8)',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: function(context) {
                        const data = context.raw;
                        if (data.status === 'current') return 8;
                        if (data.status === 'future') return 5;
                        return 4;
                    },
                    pointBackgroundColor: function(context) {
                        const data = context.raw;
                        if (data.status === 'current') return 'rgb(66, 176, 213)';
                        if (data.status === 'future') return 'rgba(255, 165, 0, 0.8)';
                        return 'rgba(138, 138, 138, 0.6)';
                    },
                    pointBorderColor: function(context) {
                        const data = context.raw;
                        if (data.status === 'current') return 'rgb(66, 176, 213)';
                        if (data.status === 'future') return 'rgba(255, 165, 0, 0.8)';
                        return 'rgba(138, 138, 138, 0.8)';
                    },
                    pointHoverRadius: function(context) {
                        const data = context.raw;
                        if (data.status === 'current') return 10;
                        if (data.status === 'future') return 7;
                        return 6;
                    },
                    fill: false,
                    tension: 0.1,
                    segment: {
                        borderDash: function(ctx) {
                            // Make future segments dashed
                            const currentIndex = interceptData.findIndex(d => d.status === 'current');
                            if (ctx.p0DataIndex >= currentIndex) {
                                return [5, 5]; // Dashed for current ‚Üí future
                            }
                            return []; // Solid for historical
                        }
                    }
                }
            ];
            
            interceptTimelineChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 600 },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const elementIndex = elements[0].index;
                            const datasetIndex = elements[0].datasetIndex;
                            const clickedWeek = datasets[datasetIndex].data[elementIndex].week;
                            selectWeek(clickedWeek);
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Departure Week',
                                font: { size: 12, weight: '600' },
                                color: 'rgb(212, 212, 212)'
                            },
                            grid: { color: 'rgba(138, 138, 138, 0.3)' },
                            ticks: { 
                                color: 'rgb(138, 138, 138)',
                                maxRotation: 45
                            },
                            border: { color: 'rgb(76, 76, 76)' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Intercept (Œ±)',
                                font: { size: 12, weight: '600' },
                                color: 'rgb(212, 212, 212)'
                            },
                            grid: { color: 'rgba(138, 138, 138, 0.3)' },
                            ticks: {
                                color: 'rgb(138, 138, 138)',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            border: { color: 'rgb(76, 76, 76)' }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: 'rgb(212, 212, 212)',
                                font: { size: 10, weight: '500' },
                                padding: 8,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(33, 33, 33, 0.95)',
                            titleColor: 'rgb(240, 240, 240)',
                            bodyColor: 'rgb(212, 212, 212)',
                            borderColor: 'rgb(76, 76, 76)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            padding: 12,
                            callbacks: {
                                title: function(tooltipItems) {
                                    const data = tooltipItems[0].raw;
                                    return `Week ${data.week}`;
                                },
                                label: function(context) {
                                    const data = context.raw;
                                    return [
                                        `Intercept (Œ±): $${Math.round(data.y).toLocaleString()}`,
                                        `Reference Price: $${data.reference_price.toLocaleString()}`,
                                        `Status: ${data.status.charAt(0).toUpperCase() + data.status.slice(1)}`,
                                        data.status === 'future' ? 'Click to plan this week' : 'Click to view details'
                                    ];
                                }
                            }
                        }
                    },
                    interaction: { intersect: false, mode: 'point' }
                }
            });
            
            console.log('Intercept Timeline Chart initialized');
        }
        
        function initODPricingChart() {
            const ctx = document.getElementById('odPricingChart');
            if (!ctx) return;
            
            const currentTrade = document.getElementById('tradeSelect').value;
            const targetPrice = parseFloat(document.getElementById('targetPriceInput').value);
            const tradeConfig = OD_PRICING_CONFIG.trades[currentTrade];
            
            // Generate booking data and calculate model parameters
            const bookingData = generateBookingData();
            const alpha = calculateWeeklyIntercept(targetPrice, tradeConfig.reference_rank, tradeConfig.beta_slope);
            const bestFitResult = calculateParameterizedBestFit();
            
            // Create datasets
            const datasets = [];
            
            // Booking bubbles (scatter) - generated from parameterized model + noise
            datasets.push({
                label: 'Actual Bookings',
                data: bookingData.map(od => ({
                    x: od.od_rank,
                    y: od.current_price,
                    r: Math.sqrt(od.booked_volume) / 2, // Scale bubble size
                    origin: od.origin,
                    destination: od.destination,
                    volume: od.booked_volume
                })),
                backgroundColor: 'rgba(255, 180, 50, 0.7)',
                borderColor: 'rgb(255, 180, 50)',
                borderWidth: 2,
                pointHoverRadius: 8
            });
            
            // User-defined price line
            const userDefinedLineData = [];
            for (let rank = 0; rank <= 1; rank += 0.01) {
                userDefinedLineData.push({
                    x: rank,
                    y: calculatePredictedPrice(alpha, tradeConfig.beta_slope, rank)
                });
            }
            
            datasets.push({
                label: 'User-Defined Price',
                data: userDefinedLineData,
                borderColor: 'rgb(66, 176, 213)',
                backgroundColor: 'transparent',
                borderWidth: 3,
                pointRadius: 0,
                fill: false,
                tension: 0,
                type: 'line'
            });
            
            // User-defined price points for actual ODs (shows what prices would be set)
            const userDefinedPoints = OD_PRICING_CONFIG.od_structure.map(od => ({
                x: od.od_rank,
                y: calculatePredictedPrice(alpha, tradeConfig.beta_slope, od.od_rank),
                origin: od.origin,
                destination: od.destination
            }));
            
            datasets.push({
                label: 'User-Defined OD Prices',
                data: userDefinedPoints,
                backgroundColor: 'rgba(66, 176, 213, 0.8)',
                borderColor: 'rgb(66, 176, 213)',
                borderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                showLine: false,
                type: 'scatter'
            });
            
            // Line-of-best-fit (parameterized - continuous from 0 to 1)
            datasets.push({
                label: 'Line-of-Best-Fit',
                data: bestFitResult.bestFitLine.map(f => ({ x: f.rank, y: f.bestFitPrice })),
                borderColor: 'rgba(0, 170, 136, 0.8)',
                backgroundColor: 'transparent',
                borderWidth: 2,
                pointRadius: 0,
                fill: false,
                tension: 0,
                borderDash: [3, 3],
                type: 'line'
            });
            
            // Acceptable band (upper) - 1.15x parameterized line, static
            const bandUpperData = [];
            bestFitResult.bestFitLine.forEach(point => {
                bandUpperData.push({ x: point.rank, y: point.bestFitPrice * 1.15 });
            });
            
            datasets.push({
                label: 'Acceptable Band Upper',
                data: bandUpperData,
                borderColor: 'rgba(229, 62, 62, 0.5)',
                backgroundColor: 'transparent',
                borderWidth: 1,
                pointRadius: 0,
                fill: false,
                tension: 0,
                borderDash: [5, 5],
                type: 'line'
            });
            
            // Acceptable band (lower) - 0.85x parameterized line, static
            const bandLowerData = [];
            bestFitResult.bestFitLine.forEach(point => {
                bandLowerData.push({ x: point.rank, y: point.bestFitPrice * 0.85 });
            });
            
            datasets.push({
                label: 'Acceptable Band Lower',
                data: bandLowerData,
                borderColor: 'rgba(229, 62, 62, 0.5)',
                backgroundColor: 'rgba(229, 62, 62, 0.1)',
                borderWidth: 1,
                pointRadius: 0,
                fill: '-1', // Fill to previous dataset
                tension: 0,
                borderDash: [5, 5],
                type: 'line'
            });
            
            odPricingChart = new Chart(ctx, {
                type: 'bubble',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 800 },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'OD Rank (0 = cheapest, 1 = most expensive)',
                                font: { size: 14, weight: '600' },
                                color: 'rgb(212, 212, 212)'
                            },
                            min: 0,
                            max: 1,
                            grid: { color: 'rgba(138, 138, 138, 0.3)' },
                            ticks: { 
                                color: 'rgb(138, 138, 138)',
                                callback: function(value) {
                                    return value.toFixed(1);
                                }
                            },
                            border: { color: 'rgb(76, 76, 76)' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Price per FFE (USD)',
                                font: { size: 14, weight: '600' },
                                color: 'rgb(212, 212, 212)'
                            },
                            beginAtZero: false,
                            grid: { color: 'rgba(138, 138, 138, 0.3)' },
                            ticks: {
                                color: 'rgb(138, 138, 138)',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            border: { color: 'rgb(76, 76, 76)' }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: 'rgb(212, 212, 212)',
                                font: { size: 11, weight: '500' },
                                padding: 12,
                                usePointStyle: true,
                                filter: function(legendItem) {
                                    // Hide band components from legend
                                    return !legendItem.text.includes('Band');
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(33, 33, 33, 0.95)',
                            titleColor: 'rgb(240, 240, 240)',
                            bodyColor: 'rgb(212, 212, 212)',
                            borderColor: 'rgb(76, 76, 76)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            padding: 12,
                            callbacks: {
                                title: function(tooltipItems) {
                                    const item = tooltipItems[0];
                                    if (item.dataset.label === 'Actual Bookings' || item.dataset.label === 'User-Defined OD Prices') {
                                        const data = item.raw;
                                        return `${data.origin} ‚Üí ${data.destination}`;
                                    }
                                    return item.dataset.label;
                                },
                                label: function(context) {
                                    if (context.dataset.label === 'Actual Bookings') {
                                        const data = context.raw;
                                        const predicted = calculatePredictedPrice(alpha, tradeConfig.beta_slope, data.x);
                                        const delta = data.y - predicted;
                                        
                                        return [
                                            `OD Rank: ${data.x.toFixed(3)}`,
                                            `Booking Price: $${data.y.toLocaleString()}`,
                                            `User-Defined Price: $${predicted.toFixed(0)}`,
                                            `Delta (Œî): $${delta.toFixed(0)}`,
                                            `Booked Volume: ${data.volume} FFE`
                                        ];
                                    } else if (context.dataset.label === 'User-Defined OD Prices') {
                                        const data = context.raw;
                                        return [
                                            `OD Rank: ${data.x.toFixed(3)}`,
                                            `User-Defined Price: $${data.y.toLocaleString()}`,
                                            `This price would be set for this corridor`
                                        ];
                                    } else {
                                        return `${context.dataset.label}: $${Math.round(context.parsed.y).toLocaleString()}`;
                                    }
                                }
                            }
                        }
                    },
                    interaction: { intersect: false, mode: 'point' }
                }
            });
            
            // Update model parameters display
            updateModelParametersDisplay(alpha, tradeConfig.beta_slope, tradeConfig.reference_rank);
            
            console.log('OD Pricing Chart initialized');
        }
        
        // Update model parameters display
        function updateModelParametersDisplay(alpha, beta, referenceRank) {
            document.getElementById('tradeSlopeDisplay').textContent = beta.toFixed(3);
            document.getElementById('weeklyInterceptDisplay').textContent = '$' + Math.round(alpha).toLocaleString();
            document.getElementById('referenceRankDisplay').textContent = referenceRank.toFixed(3);
        }
        
        // Update chart when controls change (only predicted line moves, bands stay static)
        function updateODPricingChart() {
            if (!odPricingChart) return;
            
            const targetPrice = parseFloat(document.getElementById('targetPriceInput').value);
            const currentTrade = document.getElementById('tradeSelect').value;
            const tradeConfig = OD_PRICING_CONFIG.trades[currentTrade];
            
            // Recalculate intercept
            const alpha = calculateWeeklyIntercept(targetPrice, tradeConfig.reference_rank, tradeConfig.beta_slope);
            
            // Update predicted line ONLY (bands stay static)
            const predictedLineData = [];
            for (let rank = 0; rank <= 1; rank += 0.01) {
                predictedLineData.push({
                    x: rank,
                    y: calculatePredictedPrice(alpha, tradeConfig.beta_slope, rank)
                });
            }
            
            // Find and update user-defined price line dataset
            const userDefinedDataset = odPricingChart.data.datasets.find(d => d.label === 'User-Defined Price');
            if (userDefinedDataset) {
                userDefinedDataset.data = predictedLineData;
            }
            
            // Update user-defined OD price points
            const userDefinedPoints = OD_PRICING_CONFIG.od_structure.map(od => ({
                x: od.od_rank,
                y: calculatePredictedPrice(alpha, tradeConfig.beta_slope, od.od_rank),
                origin: od.origin,
                destination: od.destination
            }));
            
            const userDefinedPointsDataset = odPricingChart.data.datasets.find(d => d.label === 'User-Defined OD Prices');
            if (userDefinedPointsDataset) {
                userDefinedPointsDataset.data = userDefinedPoints;
            }
            
            // Acceptable bands stay static - they don't move with intercept changes
            
            // Update chart scaling dynamically
            updateChartScaling();
            
            odPricingChart.update('none');
            updateModelParametersDisplay(alpha, tradeConfig.beta_slope, tradeConfig.reference_rank);
        }
        
        // Select week from timeline (updates main OD chart)
        function selectWeek(week) {
            console.log(`Selected week: ${week}`);
            
            // Check if week exists in our data
            if (!OD_PRICING_CONFIG.weekly_intercepts[week]) {
                console.error(`Week ${week} not found in weekly_intercepts`);
                return;
            }
            
            OD_PRICING_CONFIG.selected_week = week;
            
            // Update week selector dropdown (ensure value exists)
            const weekSelect = document.getElementById('weekSelect');
            const weekOption = Array.from(weekSelect.options).find(option => option.value === week);
            if (weekOption) {
                weekSelect.value = week;
            } else {
                console.error(`Week ${week} not found in dropdown options`);
            }
            
            // Update target price input based on selected week
            const weekData = OD_PRICING_CONFIG.weekly_intercepts[week];
            if (weekData) {
                // For future weeks, use the current intercept if it exists, otherwise reference price
                const targetPrice = weekData.status === 'future' ? 
                    (weekData.intercept ? calculateReferencePrice(weekData.intercept) : weekData.reference_price) :
                    weekData.reference_price;
                    
                document.getElementById('targetPriceInput').value = targetPrice;
                
                // Update current PENNY price (simulate slight variation)
                const pennyVariation = (Math.random() - 0.5) * 0.02; // ¬±1% variation
                const pennyPrice = Math.round(weekData.reference_price * (1 + pennyVariation));
                document.getElementById('currentPennyPrice').value = pennyPrice;
            }
            
            // Regenerate OD chart for selected week
            if (odPricingChart) {
                odPricingChart.destroy();
                initODPricingChart();
            }
            
            // Highlight selected week in timeline
            highlightSelectedWeek(week);
        }
        
        // Calculate reference price from intercept (reverse calculation)
        function calculateReferencePrice(intercept) {
            const tradeConfig = OD_PRICING_CONFIG.trades['E1W'];
            return intercept * Math.exp(tradeConfig.beta_slope * tradeConfig.reference_rank);
        }
        
        // Update timeline intercept when user changes target price
        function updateTimelineIntercept() {
            if (!interceptTimelineChart) return;
            
            const selectedWeek = OD_PRICING_CONFIG.selected_week;
            const targetPrice = parseFloat(document.getElementById('targetPriceInput').value);
            const tradeConfig = OD_PRICING_CONFIG.trades['E1W'];
            
            // Calculate new intercept
            const newIntercept = calculateWeeklyIntercept(targetPrice, tradeConfig.reference_rank, tradeConfig.beta_slope);
            
            // Update the data structure
            OD_PRICING_CONFIG.weekly_intercepts[selectedWeek].intercept = newIntercept;
            
            // Find and update the appropriate point in the timeline dataset
            const timelineDataset = interceptTimelineChart.data.datasets[0]; // Single dataset now
            const pointIndex = timelineDataset.data.findIndex(point => point.week === selectedWeek);
            if (pointIndex !== -1) {
                timelineDataset.data[pointIndex].y = newIntercept;
            }
            
            interceptTimelineChart.update('none');
            console.log(`Updated timeline intercept for ${selectedWeek}: $${Math.round(newIntercept)}`);
        }
        
        // Highlight selected week in timeline chart
        function highlightSelectedWeek(selectedWeek) {
            if (!interceptTimelineChart) return;
            
            // Add selection indicator (could enhance this further)
            console.log(`Highlighted week: ${selectedWeek} in timeline`);
        }
        
        // Update chart scaling dynamically based on data
        function updateChartScaling() {
            if (!odPricingChart) return;
            
            // Get all price values from all datasets
            let allPrices = [];
            
            odPricingChart.data.datasets.forEach(dataset => {
                if (dataset.data && dataset.data.length > 0) {
                    dataset.data.forEach(point => {
                        if (point && point.y !== null && point.y !== undefined) {
                            allPrices.push(point.y);
                        }
                    });
                }
            });
            
            if (allPrices.length > 0) {
                const minPrice = Math.min(...allPrices);
                const maxPrice = Math.max(...allPrices);
                const padding = (maxPrice - minPrice) * 0.1; // 10% padding
                
                odPricingChart.options.scales.y.min = Math.max(1000, minPrice - padding);
                odPricingChart.options.scales.y.max = maxPrice + padding;
            }
        }
        
        // =================================================================
        // EVENT HANDLERS
        // =================================================================
        
        // Use PENNY price button
        document.getElementById('usePennyPriceBtn').addEventListener('click', function() {
            const pennyPrice = document.getElementById('currentPennyPrice').value;
            document.getElementById('targetPriceInput').value = pennyPrice;
            updateODPricingChart();
        });
        
        // Target price input change
        document.getElementById('targetPriceInput').addEventListener('input', function() {
            updateODPricingChart();
            updateTimelineIntercept();
        });
        
        // Trade selection change
        document.getElementById('tradeSelect').addEventListener('change', function() {
            // For now, we only have E1W data
            if (this.value !== 'E1W') {
                alert('Only E1W trade data is available in this demo');
                this.value = 'E1W';
                return;
            }
            updateODPricingChart();
        });
        
        // =================================================================
        // INITIALIZATION
        // =================================================================
        
        // Initialize when page loads
        window.addEventListener('load', function() {
            if (typeof Chart !== 'undefined') {
                initInterceptTimelineChart();
                initODPricingChart();
            } else {
                console.log('Chart.js not loaded, retrying in 500ms...');
                setTimeout(function() {
                    initInterceptTimelineChart();
                    initODPricingChart();
                }, 500);
            }
        });
    </script>
</body>
</html>
